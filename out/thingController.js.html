<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: thingController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: thingController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const client = require('../utils/mongoUtil')
const getDate = require('../utils/getDateUtil')
const validate = require("../utils/ajvUtil")

//默认路由
/**
 * GET date
 * @param {} ctx 
 * @param {*} next 
 */
async function date(ctx, next) { 
    ctx.body = getDate()  
}

/**
 * addThing
 * @param {*} ctx 
 * @param {*} next 
 */
async function addThing(ctx, next) {
    const info = ctx.request.body
    const newThing = {
      body:info.body,
      status:false,
      date:getDate(1),
      type:info.type,
      edit:0,
    }
    //数据校验
    if(!validate(newThing)) return

    //链接数据库
    await client.connect()
    const db =  client.db("koa_test")
    const thingCol = db.collection("thingDB")
    
    let msg = await thingCol.insertOne(newThing)
    ctx.body = msg
    
  }

//删除事件
async function deleteThing(ctx, next) {
    //数据库操作
    await client.connect()
    const db =  client.db("koa_test")
    const thingCol = db.collection("thingDB")
    
    ctx.body = await thingCol.deleteOne(ctx.request.body)
    
}

//更新事件
async function updateThing(ctx, next) {
    let oldBody = {
      body:ctx.request.body.oldBody
    }
    let newBody = {
      $set:{
        body:ctx.request.body.newBody
      }
    }
  
    await client.connect()
    let db =  client.db("koa_test")
    let thingCol = db.collection("thingDB")
    
    ctx.body = await thingCol.updateOne(oldBody,newBody)
}

//查找事件
async function findThing(ctx, next) {
    let findInfo = {
      type : parseInt(ctx.request.query.type)
    }
    let reqstatus = ctx.request.query.status
    
    if(reqstatus == 0){
      findInfo.status = false
    }else if(reqstatus ==  1){
      findInfo.status = true
    }
    await client.connect()
    const db =  client.db("koa_test")
    const thingCol = db.collection("thingDB")
   
    ctx.body = await thingCol.find(findInfo).toArray();
}

//更改状态
async function changeEdit(ctx, next) {
    const findInfo = {
      body:ctx.request.body.body
    }
    
    const changeInfo = {
      $set:{
        status:!ctx.request.body.status
      }   
    }
    await client.connect()
    const db =  client.db("koa_test")
    const thingCol = db.collection("thingDB")
   
    ctx.body = await thingCol.updateOne(findInfo,changeInfo) 
}

module.exports = {
    date,
    addThing,
    deleteThing,
    updateThing,
    findThing,
    changeEdit
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addThing">addThing</a></li><li><a href="global.html#date">date</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Tue Jul 09 2019 10:50:02 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
